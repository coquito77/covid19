---
title: "Untitled"
output: pdf_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(cache = TRUE, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE,
                      #dpi = 500
                      dev = "cairo_pdf")


setwd("~/GitHub/covid19")

library(tidyverse)
library(xml2)
library(rvest)
library(sf)
library(lubridate)
library(data.table)
library(tidycensus)
#setwd("")

options(scipen = 999)

rm(list = ls()) #start with empty workplace

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r todo, eval = FALSE}

1. get census tract pop by age
2. get H1N1 counts of infected, hospitalized, and death -- done
3. extrapolate to pop from step 1 and month.abb
3. get calif hospital bed capacity

```


```{r getData, eval = FALSE}


# get cdc estimates from H1N1
#
linkEstimates <- "https://www.cdc.gov/h1n1flu/estimates_2009_h1n1.htm/" %>%
  read_html() %>%
  html_nodes("a") %>%
  html_attr("href") %>%
  .[grepl("estimates", .)] %>%
  sapply(., function(x)
    case_when(
      grepl("h1n1flu", x, ignore.case = TRUE) ~ paste0("https://www.cdc.gov", x),
      TRUE ~  paste0("https://www.cdc.gov/h1n1flu/", x)
    )) %>%
  as.list() %>%
  as.character()

data_ <- list()

startTime <- Sys.time() # start timer

for (i in seq_along(linkEstimates)) {
  
  timediff <- Sys.time() - startTime 
  
  print(paste0(
    i,
    " of "
    ,    length(linkEstimates)
    ," -- ",as.double(timediff, units = "auto") %>% signif(.,3)
    ," "
    ,units(timediff)
    ,
    " -- ",
    linkEstimates[i]
  ))
  
  data_[[i]] <- linkEstimates[i] %>% 
    read_html(.) %>%
    html_table(fill = TRUE, header = NA) %>% 
    as.data.frame() %>% # t %>% 
    setNames( .[1,] %>% unlist() %>% as.character()) %>% 
    setNames(gsub("[^[:alnum:]]", perl = TRUE, "", names(.))) %>% 
    setNames( make.names(names(.), unique = TRUE)) %>% 
    mutate(type = case_when(grepl("Cases$|Hospitalizations$|Deaths$",X2009H1N1 )~ X2009H1N1),
           type = zoo::na.locf(type, na.rm = FALSE) ) %>% 
    mutate_all(list(~trimws(gsub("\\s+", " ", .)))) %>% 
    separate(EstimatedRange, c("lowEst", "highEst"), "to", extra = "merge") %>% 
    filter(!is.na(type)) %>% 
    pivot_longer(-c(X2009H1N1,type)
                 ,  names_to = "metric", values_to = "value") %>% 
    mutate(Valuenum =  gsub("[^[:digit:].]", "", value),
           Valuenum = as.numeric(Valuenum),
           Valuenum  = case_when(grepl("million", value)  ~ Valuenum * 1e6,
                                 grepl("billion", value)  ~ Valuenum * 1e9,
                                 TRUE ~ Valuenum *1),
           link = linkEstimates[i]) #%>% View
}

cdc_estimates <- data_ %>% # head(1000) %>% # "541/541 2.3 mins"
  plyr::ldply(data.frame) %>% 
  filter(!is.na(Valuenum))

save(cdc_estimates, file = "cdc_estimates.RData")


# get hospital data from the state

# unlink("hosp18.RData")

if(!file.exists("hosp18.RData")) {
  
  print("Wait for file to be downloaded")
  
  tmp <- tempfile(fileext = ".xlsx")
  
  download.file("https://data.chhs.ca.gov/dataset/1902083c-f16a-434d-b8ac-f7a573a305df/resource/71b3ecc0-961d-44ff-8f6b-fdaded864380/download/hosp18_util_data_final.xlsx" 
                ,mode = "wb"
                ,tmp)
  
  hosp18 <- readxl::read_excel(tmp,
                               sheet = 2,
                               ,col_types = "text") %>% 
    #select(2:40, contains("bed"), contains("EMER_")) %>% 
    setNames(make.names(names(.)))
  
  unlink(tmp)
  
  save(hosp18, file = "hosp18.RData")
  
} else {
  
  print("file has been downloaded")
  
}

hosp18 %>% names %>% View

hosp18 %>% filter(HEALTH_SVC_AREA == "12 - Inland Counties" & LIC_CAT == "General Acute Care Hospital") %>% 
  select(FAC_NAME, LIC_CAT, TOT_LIC_BEDS
        ,  IC_LIC_BEDS, ACUTE_RESPIRATORY_CARE_LIC_BEDS) %>%
  mutate_at(vars( contains("BED"))
            ,list(~as.numeric(.))) %>% View()

# download state and census track shape files
# https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html

if(file.exists("cb_2018_us_county_500k.Rdata")) {
  
  print("file has been unziped already")
  
} else {
  
  ifelse(!dir.exists(file.path("./shapefiles")),
         dir.create(file.path("./shapefiles")), FALSE)
  
  td = tempdir()
  # create the placeholder file
  tf = tempfile(tmpdir = td, fileext = ".zip")
  # download into the placeholder file
  download.file("https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_us_county_500k.zip"
               ,  tf)
  
  # get the name of the first file in the zip archive
  fname = unzip(tf, exdir = "shapefiles") #, list=TRUE)  $Name %>% .[grepl("shp$",.)]
  
  cb_2018_us_county_500k = sf::st_read("./shapefiles/cb_2018_us_county_500k.shp") %>% # 
    #st_transform(., 2229) %>% # change coordinte system to LA County official system
    sf::st_transform(., 4326) # change it to GPS satellite navigation system
  
  sf::st_crs(cb_2018_us_county_500k)
  
  save(cb_2018_us_county_500k, file = "cb_2018_us_county_500k.Rdata")
  
  unlink(td)
  unlink(tf)
  
}

if(file.exists("cb_2018_us_county_500k.Rdata")) {
  
  print("file has been unziped already")
  
} else {
  
  ifelse(!dir.exists(file.path("./shapefiles")),
         dir.create(file.path("./shapefiles")), FALSE)
  
  td = tempdir()
  # create the placeholder file
  tf = tempfile(tmpdir = td, fileext = ".zip")
  # download into the placeholder file
  download.file("https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_06_tract_500k.zip"
               ,  tf)
  
  # get the name of the first file in the zip archive
  fname = unzip(tf,
                exdir = "shapefiles") #, list=TRUE)  $Name %>% .[grepl("shp$",.)]
  
  cb_2018_06_tract_500 <- list.files(recursive = TRUE
                                     ,pattern = "shp$") %>% 
    .[grepl("cb_2018_06_tract_500",.)] %>% 
    sf::read_sf(quiet = TRUE, stringsAsFactors = FALSE) %>% 
    sf::st_transform(., 4269)
  
  sf::st_crs(cb_2018_06_tract_500)
  
  save(cb_2018_06_tract_500, file = "cb_2018_06_tract_500.Rdata")
  
  unlink(td)
  unlink(tf)
  
}

if(file.exists("cb_2018_us_county_500k.Rdata")) {
  
  print("file has been unziped already")
  
} else {
  
  ifelse(!dir.exists(file.path("./shapefiles")),
         dir.create(file.path("./shapefiles")), FALSE)
  
  td = tempdir()
  # create the placeholder file
  tf = tempfile(tmpdir = td, fileext = ".zip")
  # download into the placeholder file
  download.file("https://www2.census.gov/geo/tiger/GENZ2018/shp/cb_2018_06_tract_500k.zip"
               ,  tf)
  
  # get the name of the first file in the zip archive
  fname = unzip(tf,
                exdir = "shapefiles") #, list=TRUE)  $Name %>% .[grepl("shp$",.)]
  
  cb_2018_06_tract_500 <- list.files(recursive = TRUE
                                     ,pattern = "shp$") %>% 
    .[grepl("cb_2018_06_tract_500",.)] %>% 
    sf::read_sf(quiet = TRUE, stringsAsFactors = FALSE) %>% 
    sf::st_transform(., 4269)
  
  sf::st_crs(cb_2018_06_tract_500)
  
  save(cb_2018_06_tract_500, file = "cb_2018_06_tract_500.Rdata")
  
  unlink(td)
  unlink(tf)
  
}

# data_Date <- Sys.Date()
# 
# US_CoronaVirus <- data.table::fread("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv")
# # 
# # save(US_CoronaVirus, file = "US_CoronaVirus.Rdata")
# 
# US_StCoronaVirus <- data.table::fread("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv")
# 
# save(US_StCoronaVirus, data_Date, US_CoronaVirus, file = "US_CoronaVirus.Rdata")

if(!file.exists("US_StCoronaVirus.xlsx"))
  
  US_StCoronaVirus %>% 
  openxlsx::write.xlsx("US_StCoronaVirus.xlsx"
                       ,startCol = c(1), startRow = 1, asTable = c(TRUE)
                      ,  withFilter = c(TRUE)
                      ,  rowNames = FALSE
                      ,  tableStyle = "TableStyleMedium2")

# get holidays

dat_Hldy <- "https://www.timeanddate.com/holidays/us/2009" %>% 
  read_html(.) %>%
  html_table(fill = TRUE, header = NA) %>% 
  as.data.frame() %>% # t %>% 
  #setNames( .[1,] %>% unlist() %>% as.character()) %>% 
  setNames(gsub("[^[:alnum:]]", perl = TRUE, "", names(.))) %>% 
  mutate(EndMonth = as.Date(paste0("2009 ", Date) ,format = "%Y %b %d")) %>% 
  bind_rows(
    "https://www.timeanddate.com/holidays/us/2010" %>% 
      read_html(.) %>%
      html_table(fill = TRUE, header = NA) %>% 
      as.data.frame() %>% # t %>% 
      #setNames( .[1,] %>% unlist() %>% as.character()) %>% 
      setNames(gsub("[^[:alnum:]]", perl = TRUE, "", names(.))) %>% 
      mutate(EndMonth = as.Date(paste0("2010 ", Date) ,format = "%Y %b %d"))
  ) %>% 
  bind_rows(
    "https://www.timeanddate.com/holidays/us/2020" %>% 
      read_html(.) %>%
      html_table(fill = TRUE, header = NA) %>% 
      as.data.frame() %>% # t %>% 
      #setNames( .[1,] %>% unlist() %>% as.character()) %>% 
      setNames(gsub("[^[:alnum:]]", perl = TRUE, "", names(.))) %>% 
      mutate(EndMonth = as.Date(paste0("2020 ", Date) ,format = "%Y %b %d"))
    
  )

save(dat_Hldy, file = "dat_Hldy.Rdata")

```

```{r getILI_Cnts_SB_CO, eval = FALSE}

yrLinks <- "http://wp.sbcounty.gov/dph/wp-content/uploads/sites/7/" %>%
  read_html() %>%
  html_nodes("a") %>%
  html_attr("href") %>%
  .[grepl("20", .)] %>% 
  paste0("http://wp.sbcounty.gov/dph/wp-content/uploads/sites/7/",.) 

moLisnk_ <- list()

for(i in seq(yrLinks)) {
  
  moLisnk_[[i]] <- yrLinks[i] %>%
    read_html() %>%
    html_nodes("a") %>%
    html_attr("href") %>%
    .[grepl("\\d{2}", .)] %>% 
    paste0(yrLinks[i], .)
  
}

moLisnk <- moLisnk_ %>%
  flatten() %>% 
  as.character()

iliList_ <- list()

for(i in seq(moLisnk)) {
  
  iliList_[[i]] <- moLisnk[i] %>%
    read_html() %>%
    html_nodes("a") %>%
    html_attr("href") %>%
    .[grepl("ili", ., ignore.case = TRUE)] %>% 
    paste0(moLisnk[i], .)
  
}

iliList <- iliList_ %>% 
  flatten() %>% 
  as.character() %>% 
  .[grepl("Weekly",.)]

wklyCnts_ <- list()

startTime <- Sys.time() # start timer

for (i in seq_along(iliList)) {
  
  timediff <- Sys.time() - startTime 
  
  print(paste0(
    i,
    " of "
    ,    length(iliList)
    ," -- ",as.double(timediff, units = "auto") %>% signif(.,3)
    ," "
    ,units(timediff)
    ,
    " -- ",
    iliList[i]
  ))
  
  url <- iliList[i]
  
  txt <- pdftools::pdf_text(url)
  
  tableLocation <- grep("Average Weekly Percentage|Percentage of ILI Emergency", txt) %>% min
  
  x <-txt %>% 
    .[[tableLocation]]  %>% 
    str_split("\n") %>% 
    as.data.frame() %>% 
    select(var = 1)
  
  row1 <- grep("MMWR|Average Weekly Percentage", x$var ) %>% min()
  
  lastrow <- row1 + 8 #grep("Figure 1", x$var ) - 1
  
  if(FALSE) {
    
    lastrow <- if (length(lastrow) != 0 ) {
      lastrow
    } else if ( length(lastrow) == 0 & lastrow != row1) {
      row1 + 8
    }
    
    lastrow == row1
  }
  
  x1 <- x %>%
    slice(row1:lastrow) %>% 
    mutate(var = sub("MMWR Week", "MMWR_Week", var),
           var = gsub("\\s+", " ", var),
           var = trimws(var)) 
  
  row1 <- grep("Week ", x1$var ) %>% min()
  
  wklyCnts_[[i]] <- x1 %>% 
    slice(row1:nrow(x1)) %>% 
    separate(var, c("Wk", "YrA", "YrB", "YrC")
             ,  extra = "merge", sep = " ") %>% 
    setNames( .[1,] %>% unlist() %>% as.character()) %>% 
    setNames(gsub("[^[:alnum:]-]", perl = TRUE, "", names(.))) %>% 
    mutate(file = sub(".*sites/\\d/\\d{4}/\\d{2}/(.*)" ,"\\1", url)) %>%
    filter_at( vars(starts_with("20")), any_vars(grepl("%",. ))) %>%
    rowid_to_column( var = "rowid") %>% 
    pivot_longer(-c(1:2, file), names_to = "Yr", values_to = "Pcnt") %>% 
    mutate(iteration = i)
  
}

Sys.time() - startTime

wklyCnts <- data.table::rbindlist(wklyCnts_, fill = TRUE)

save(wklyCnts, file = "wklyCnts.RData")

```

```{r analyzeData, eval = FALSE}

rm(list = ls()) #start with empty workspace

# unlink("counties_2018acs.rds")

if( !file.exists("counties_2018acs.rds") ) {
  
  census_api_key(Sys.getenv("census_api_key")
                 #,install = TRUE
  )
  
  v18 <- load_variables(2018, "acs5", cache = TRUE)
  
  my_vars <- c(
    total_pop = "B01003_001",
    median_income = "B19013_001",
    Othr_Relatives_LIVI_ARRA_OF_ADUL_65_yers_and_over = "B09021_027",
    Othr_nonRelatives_LIVI_ARRA_OF_ADUL_65_yers_and_over = "B09021_028",
    Pctn_Publictrans_to_work = "DP03_0021P",
    Pctn_Service_occupations = "DP03_0028P",
    Per_capita_income = "DP03_0088",
    Pctn_Health_insurance = "DP03_0096P",
    Pctn_Below_FP_All_people = "DP03_0128P"
  )
  
  counties_2018acs <- map_dfr(
    #my_states,
    state.abb,
    ~ get_acs(
      geography = "county",
      variables = my_vars,
      state = .,
      year = 2018,
      survey = "acs5", # 2014-2018 5-year ACS
      geometry = FALSE
    )
  )
  
  saveRDS(counties_2018acs, "counties_2018acs.rds")
  saveRDS(my_vars, "my_vars.rds")
} else { 
  
  counties_2018acs <- read_rds("counties_2018acs.rds")
  my_vars <- read_rds("my_vars.rds")
  
}

theme_set(theme_bw())

# https://freakonometrics.hypotheses.org/60482

load("cdc_estimates.RData")

if(FALSE) {
  
  system(paste0('open "'
                ,'helperFunctions.r'
                , '"'))
  
}

source("helperFunctions.r")

cdcInterpolated<- intr_Dat(cdc_estimates)

t_intr_estm <- est_intr_Dat(cdcInterpolated)

rm(list = setdiff(ls(), c("counties_2018acs",
                          "my_vars",
                          "t_intr_estm",
                          "cdc_estimates",
                          "cdcInterpolated")))

if( !exists("US_CoronaVirus")) {
  
  source('~/GitHub/covid19/covid19DataNYTimes.R')
  
  saveRDS(US_CoronaVirus
          , paste0("US_CoronaVirus_",Sys.Date() %>% gsub("-","_",.), ".rds")
  )
  
}

if(FALSE) system(paste0('open "', "helperFunctions.r", '"'))

source("helperFunctions.r")

cols <- c("Cases" = "#d8b365", "Deaths" = "#998ec3", "Hospitalizations" = "#5ab4ac")

sum_US_CoronaVirus <- US_CoronaVirus %>% 
  group_by(date) %>% 
  summarise(totalDailyCases = sum(cases, rm.na = TRUE),
            totalDeaths = sum(deaths, rm.na = TRUE)) %>% 
  ungroup %>% 
  mutate(dayCnt = 1,
         dayCnt = cumsum(dayCnt))

# crate column dayCnt to id both sets

t_intr_estm <- t_intr_estm %>% 
  left_join( data.frame(EndMonth = seq(t_intr_estm$EndMonth %>% min()
                                       ,t_intr_estm$EndMonth %>% max(),
                                       by = "day")) %>% 
               mutate(dayCnt = 1,
                      dayCnt = cumsum(dayCnt))
  )

### Total cases ####

Cov_currentDay <- sum_US_CoronaVirus %>% 
  filter(date == max(date))

H1N1_Case_currentDay <- t_intr_estm %>% 
  filter(Pop_type == "Cases Total_Cases") %>% 
  mutate(type = "Cases") %>% 
  filter(dayCnt == Cov_currentDay$dayCnt)

H1N1_Case_Max <- t_intr_estm %>% 
  filter(Pop_type == "Cases Total_Cases") %>% 
  mutate(type = "Cases") %>% 
  filter(dayCnt == max(t_intr_estm$dayCnt))

H1N1_Death_currentDay <- t_intr_estm %>% 
  filter(Pop_type == "Deaths Total_Deaths") %>% 
  mutate(type = "Deaths") %>% 
  filter(dayCnt == Cov_currentDay$dayCnt)

H1N1_Death_Max <- t_intr_estm %>% 
  filter(Pop_type == "Deaths Total_Deaths") %>% 
  mutate(type = "Deaths") %>% 
  filter(dayCnt == max(t_intr_estm$dayCnt))

# create pdf file with charts ####

if( file.exists( paste0("2019H1N1_vs_COVID19_"
                        ,data_Date %>% gsub("-","",.),".pdf"))  ) 
  unlink( paste0("2019H1N1_vs_COVID19_"
                 ,data_Date %>% gsub("-","",.),".pdf")
  )

Cairo::CairoPDF(file = paste0("2019H1N1_vs_COVID19_"
                              ,data_Date %>% gsub("-","",.),".pdf"),
                #units = "in", dpi = 150,
                width = 8, 
                height = 11, 
                pointsize = 10)

if(FALSE) {
  
  t_intr_estm %>%
    separate(Pop_type, c("X2009H1N1", "type"), sep = "_") %>% 
    ggplot +
    geom_ribbon(aes(x = EndMonth,
                    ymin = imp_lowEst,
                    ymax = imp_highEst
                    ,group = type
                    ,fill = type)
                ,alpha = .5) +
    geom_line( aes(x = EndMonth, y = imp_MidLevelRange
                   ,group = type
                   ,color = type)
    ) +
    geom_errorbar(data = cdcInterpolated %>%
                    select(Pop_type#, type
                           ,EndMonth
                           ,MidLevelRange
                           ,imp_lowEst = lowEst
                           ,imp_highEst = highEst) %>% 
                    separate(Pop_type, c("X2009H1N1", "type"), sep = "_")
                  ,aes(ymin = imp_lowEst, ymax = imp_highEst
                       ,x =EndMonth
                       ,group = type), width = .2,
                  position = position_dodge(.9),
                  ,alpha = .4) +
    scale_y_log10(label= scales::comma) +
    facet_wrap(vars( X2009H1N1), scales = "free") +
    theme(legend.position = "top")
  
}

t_intr_estm %>%
  separate(Pop_type, c("X2009H1N1", "type"), sep = "_") %>% 
  ggplot +
  geom_ribbon(aes(x = EndMonth,
                  ymin = imp_lowEst,
                  ymax = imp_highEst
                  ,group = type
                  ,fill = type)
              ,alpha = .5) +
  geom_line( aes(x = EndMonth, y = imp_MidLevelRange
                 ,group = type
                 #,color = type
  )
  ) +
  geom_errorbar(data = cdcInterpolated %>%
                  select(Pop_type#, type
                         ,EndMonth
                         ,MidLevelRange
                         ,imp_lowEst = lowEst
                         ,imp_highEst = highEst) %>% 
                  separate(Pop_type, c("X2009H1N1", "type"), sep = "_")
                ,aes(ymin = imp_lowEst, ymax = imp_highEst
                     ,x = EndMonth
                     ,group = type), width = 1,
                position = position_dodge(.9)
                ,alpha = .4) +
  scale_fill_manual(name = "Type",
                    values = cols) +
  scale_y_continuous(label = human_numbers) +
  scale_x_date(breaks = seq(min(t_intr_estm$EndMonth), max(t_intr_estm$EndMonth), by = "1 month"),
               labels = pretty_date_breaks( seq(min(t_intr_estm$EndMonth), max(t_intr_estm$EndMonth), by = "1 month")
                                            ,format1 = "%Y %b", format2 = "%Y %b")
               #,limits = c(1900,2000), expand = c(0,0)
  ) +  
  facet_wrap(vars( X2009H1N1), scales = "free") +
  theme_plot +
  #theme(legend.position = "top") +
  labs(title = "2009 H1N1 (swine flu pandemic) cases, deaths, and hospitalizations"
       ,subtitle = "Interpolated counts from counts from Oct 2009 to March 2010
       The CDC provided middle, low and high, estimate counts for the categories below for
each month from Oct 2009 to March 2010.
       Estimates starting from April 2009 (the beginning of the H1N1 pandemic) are not given,
these were interpolated using spline estimation."
,y = "Estimated count"
,x = ""
,caption = paste("Source: https://www.cdc.gov/h1n1flu/estimates_2009_h1n1.htm (H1N1)
                        First case was reported on April 13, 2009 https://www.cdc.gov/mmwr/preview/mmwrhtml/mm5815a5.htm")
  ) #+ theme(axis.text.x = element_text(angle = 90, hjust = 1))

t_intr_estm %>%
  separate(Pop_type, c("X2009H1N1", "type"), sep = "_") %>% 
  ggplot +
  geom_ribbon(aes(x = EndMonth,
                  ymin = imp_lowEst,
                  ymax = imp_highEst
                  ,group = type
                  ,fill = type)
              ,alpha = .5) +
  geom_line( aes(x = EndMonth, y = imp_MidLevelRange
                 ,group = type
                 #,color = type
  )
  ) +
  geom_errorbar(data = cdcInterpolated %>%
                  select(Pop_type#, type
                         ,EndMonth
                         ,MidLevelRange
                         ,imp_lowEst = lowEst
                         ,imp_highEst = highEst) %>% 
                  separate(Pop_type, c("X2009H1N1", "type"), sep = "_")
                ,aes(ymin = imp_lowEst, ymax = imp_highEst
                     ,x = EndMonth
                     ,group = type), width=.2,
                position = position_dodge(.9)
                ,alpha = .4) +
  scale_fill_manual(name = "Type",
                    values = cols) +
  scale_y_log10(label = human_numbers ,limits = c(1, NA)) +
  #coord_cartesian( ylim = c(1, NA)) +
  facet_wrap(vars( X2009H1N1), scales = "free") +
  scale_x_date(breaks = seq(min(t_intr_estm$EndMonth), max(t_intr_estm$EndMonth), by = "1 month"),
               labels = pretty_date_breaks( seq(min(t_intr_estm$EndMonth), max(t_intr_estm$EndMonth), by = "1 month")
                                            ,format1 = "%Y %b", format2 = "%Y %b")
               #,limits = c(1900,2000), expand = c(0,0)
  ) +
  theme_plot +
  #theme(legend.position = "top") +
  labs(title = "2009 H1N1 (swine flu pandemic) cases, deaths, and hospitalizations"
       ,subtitle = "Interpolated counts from counts from Oct 2009 to March 2010
       The CDC provided middle, low and high, estimate counts for the categories below for 
each month from Oct 2009 to March 2010.
       Estimates starting from April 2009 (the beginning of the H1N1 pandemic) are not given, 
these were interpolated using spline estimation."
,y = "Estimated count"
,x = ""
,caption = paste("Note: y-axis is in log scale
Source: https://www.cdc.gov/h1n1flu/estimates_2009_h1n1.htm (H1N1)
                        First case was reported on April 13, 2009 https://www.cdc.gov/mmwr/preview/mmwrhtml/mm5815a5.htm")
  ) +
  annotation_logticks(sides = "l",
                      short = unit(1,"mm"),
                      mid = unit(3,"mm"),
                      long = unit(5,"mm"),
                      size = 0.2, linetype = 1
                      , alpha = .8)


sum_US_CoronaVirus %>% 
  ggplot +
  geom_ribbon(data = t_intr_estm %>% 
                filter(Pop_type == "Cases Total_Cases") %>% 
                mutate(type = "Cases"),
              aes(x = dayCnt,
                  ymin = imp_lowEst,
                  ymax = imp_highEst
                  ,group = type
                  ,fill = type
              )
              ,show.legend = FALSE
              ,alpha = .5) +
  geom_line(data = t_intr_estm %>% 
              filter(Pop_type == "Cases Total_Cases"),
            aes(x = dayCnt
                ,y = imp_MidLevelRange),
            colour = "blue") +
  geom_line(aes(x = dayCnt
                ,y = totalDailyCases),
            colour = "red") +
  geom_text(data = H1N1_Case_currentDay 
            , aes(x = dayCnt,
                  y = imp_MidLevelRange,
                  label = paste("H1N1 cases\n"
                                ,scales::comma(imp_MidLevelRange),
                                "\n(mid-range)")
            )
            , hjust = 0, nudge_x = 1
            ,colour = "blue") +
  geom_point(data = H1N1_Case_currentDay
             , aes(x = dayCnt,
                   y = imp_MidLevelRange)
             ,colour = "blue") +
  geom_text(data = Cov_currentDay 
            , aes(x = dayCnt,
                  y = totalDailyCases,
                  label = paste("COVID19 cases\n"
                                ,scales::comma(totalDailyCases))
            ) 
            , hjust = 0, nudge_x = 1
            ,colour = "red") +
  geom_point(data = Cov_currentDay
             , aes(x = dayCnt,
                   y = totalDailyCases)
             ,colour = "red") + 
  scale_fill_manual(name = "Type",
                    values = cols) +
  scale_y_log10(label = human_numbers) +
  theme_plot +
  coord_cartesian(xlim = c(1, Cov_currentDay$dayCnt+50)
                  , ylim = c(1, max(H1N1_Case_currentDay$imp_highEst))) +
  annotation_logticks(sides = "l",
                      short = unit(1,"mm"),
                      mid = unit(3,"mm"),
                      long = unit(5,"mm"),
                      size = 0.2, linetype = 1
                      , alpha = .8) +
  labs(title = "2009 H1N1 cumulative cases by day vs Covid-19"
       ,subtitle = paste(Cov_currentDay$dayCnt, "days after the first case")
       ,y = "Cases (log scale)"
       ,x = ""
       ,caption = paste("Note: y-axis is in log scale
                        Sources: The New York Times, https://github.com/nytimes/covid-19-data accessed"
                        ,data_Date
                        ,"(Covid19);
       https://www.cdc.gov/h1n1flu/estimates_2009_h1n1.htm (H1N1)")
  )


sum_US_CoronaVirus %>% 
  ggplot +
  geom_ribbon(data = t_intr_estm %>% 
                filter(Pop_type == "Cases Total_Cases") %>% 
                mutate(type = "Cases"),
              aes(x = dayCnt,
                  ymin = imp_lowEst,
                  ymax = imp_highEst
                  ,group = type
                  ,fill = type
              )
              ,show.legend = FALSE
              ,alpha = .5) +
  geom_line(data = t_intr_estm %>% 
              filter(Pop_type == "Cases Total_Cases"),
            aes(x = dayCnt
                ,y = imp_MidLevelRange),
            colour = "blue") +
  geom_line(aes(x = dayCnt
                ,y = totalDailyCases),
            colour = "red") +
  geom_text(data = H1N1_Case_currentDay 
            , aes(x = dayCnt,
                  y = imp_MidLevelRange,
                  label = paste("H1N1 cases\n"
                                ,scales::comma(imp_MidLevelRange),
                                "\n(mid-range)")
            )
            , hjust = 0, nudge_x = 1
            ,colour = "blue") +
  geom_point(data = H1N1_Case_currentDay
             , aes(x = dayCnt,
                   y = imp_MidLevelRange)
             ,colour = "blue") +
  geom_text(data = Cov_currentDay 
            , aes(x = dayCnt,
                  y = totalDailyCases,
                  label = paste("COVID19 cases\n"
                                ,scales::comma(totalDailyCases))
            )
            , hjust = 0, nudge_x = 1
            ,colour = "red") +
  geom_point(data = Cov_currentDay
             , aes(x = dayCnt,
                   y = totalDailyCases)
             ,colour = "red") +
  scale_fill_manual(name = "Type",
                    values = cols) +
  scale_y_continuous(label = human_numbers) +
  theme_plot +
  coord_cartesian(xlim = c(1, Cov_currentDay$dayCnt+50)
                  , ylim = c(0, max(H1N1_Case_currentDay$imp_highEst))) +
  labs(title = "2009 H1N1 cumulative cases by day vs Covid-19"
       ,subtitle = paste(Cov_currentDay$dayCnt, "days after the first case")
       ,y = "Cases"
       ,x = ""
       ,caption = paste("Sources: The New York Times, https://github.com/nytimes/covid-19-data accessed"
                        ,data_Date
                        ,"(Covid19);
       https://www.cdc.gov/h1n1flu/estimates_2009_h1n1.htm (H1N1)")
  )

sum_US_CoronaVirus %>% 
  ggplot +
  geom_ribbon(data = t_intr_estm %>% 
                filter(Pop_type == "Cases Total_Cases") %>% 
                mutate(type = "Cases"),
              aes(x = dayCnt,
                  ymin = imp_lowEst,
                  ymax = imp_highEst
                  ,group = type
                  ,fill = type
              )
              ,show.legend = FALSE
              ,alpha = .5) +
  geom_errorbar(data = cdcInterpolated %>%
                  filter(X2009H1N1 == "Cases Total") %>% 
                  select(Pop_type#, type
                         ,EndMonth
                         ,MidLevelRange
                         ,imp_lowEst = lowEst
                         ,imp_highEst = highEst) %>% 
                  separate(Pop_type, c("X2009H1N1", "type"), sep = "_") %>% 
                  inner_join(t_intr_estm %>% 
                               select(EndMonth ,dayCnt)) %>% 
                  distinct()
                ,aes(ymin = imp_lowEst, ymax = imp_highEst
                     ,x =dayCnt
                     ,group = type), width=.2,
                position = position_dodge(.9)
                ,alpha = .4) +
  geom_line(data = t_intr_estm %>% 
              filter(Pop_type == "Cases Total_Cases"),
            aes(x = dayCnt
                ,y = imp_MidLevelRange),
            colour = "blue") +
  geom_line(aes(x = dayCnt
                ,y = totalDailyCases),
            colour = "red") +
  geom_text(data = H1N1_Case_Max 
            , aes(x = dayCnt,
                  y = imp_MidLevelRange,
                  label = paste("H1N1 cases\n"
                                ,scales::comma(imp_MidLevelRange),
                                "\n(mid-range)")
            )
            , hjust = 0, nudge_x = 1
            ,colour = "blue") +
  geom_point(data = H1N1_Case_Max
             , aes(x = dayCnt,
                   y = imp_MidLevelRange)
             ,colour = "blue") +
  geom_text(data = Cov_currentDay 
            , aes(x = dayCnt,
                  y = totalDailyCases,
                  label = paste("COVID19 cases\n"
                                ,scales::comma(totalDailyCases))
            )
            , hjust = 0, nudge_x = 1
            ,colour = "red") +
  geom_point(data = Cov_currentDay
             , aes(x = dayCnt,
                   y = totalDailyCases)
             ,colour = "red") +
  scale_fill_manual(name = "Type",
                    values = cols) +
  scale_y_log10(label = human_numbers) +
  theme_plot +
  coord_cartesian(xlim = c(1, max(t_intr_estm$dayCnt)+50)
                  , ylim = c(1, H1N1_Case_Max$imp_highEst)) +
  annotation_logticks(sides = "l",
                      short = unit(1,"mm"),
                      mid = unit(3,"mm"),
                      long = unit(5,"mm"),
                      size = 0.2, linetype = 1
                      , alpha = .8) +
  labs(title = "2009 H1N1 cumulative cases by day vs Covid-19"
       ,subtitle = paste(H1N1_Case_Max$dayCnt,
                         "days after the first case")
       ,y = "Cases (log scales)"
       ,x = ""
       ,caption = paste("Note: y-axis is in log scale
                        Sources: The New York Times, https://github.com/nytimes/covid-19-data accessed"
                        ,data_Date
                        ,"(Covid19);
       https://www.cdc.gov/h1n1flu/estimates_2009_h1n1.htm (H1N1)")
  )


sum_US_CoronaVirus %>% 
  ggplot +
  geom_ribbon(data = t_intr_estm %>% 
                filter(Pop_type == "Cases Total_Cases") %>% 
                mutate(type = "Cases"),
              aes(x = dayCnt,
                  ymin = imp_lowEst,
                  ymax = imp_highEst
                  ,group = type
                  ,fill = type
              )
              ,show.legend = FALSE
              ,alpha = .5) +
  geom_errorbar(data = cdcInterpolated %>%
                  filter(X2009H1N1 == "Cases Total") %>% 
                  select(Pop_type#, type
                         ,EndMonth
                         ,MidLevelRange
                         ,imp_lowEst = lowEst
                         ,imp_highEst = highEst) %>% 
                  separate(Pop_type, c("X2009H1N1", "type"), sep = "_") %>% 
                  inner_join(t_intr_estm %>% 
                               select(EndMonth ,dayCnt)) %>% 
                  distinct()
                ,aes(ymin = imp_lowEst, ymax = imp_highEst
                     ,x =dayCnt
                     ,group = type), width=.2,
                position = position_dodge(.9)
                ,alpha = .4) +
  geom_line(data = t_intr_estm %>% 
              filter(Pop_type == "Cases Total_Cases"),
            aes(x = dayCnt
                ,y = imp_MidLevelRange),
            colour = "blue") +
  geom_line(aes(x = dayCnt
                ,y = totalDailyCases),
            colour = "red") +
  scale_fill_manual(name = "Type",
                    values = cols) +
  scale_y_continuous(label = human_numbers) +
  geom_text(data = H1N1_Case_Max 
            , aes(x = dayCnt,
                  y = imp_MidLevelRange,
                  label = paste("H1N1 cases\n"
                                ,scales::comma(imp_MidLevelRange),
                                "\n(mid-range)")
            )
            , hjust = 0, nudge_x = 1
            ,colour = "blue") +
  geom_point(data = H1N1_Case_Max
             , aes(x = dayCnt,
                   y = imp_MidLevelRange)
             ,colour = "blue") +
  geom_text(data = Cov_currentDay 
            , aes(x = dayCnt,
                  y = totalDailyCases,
                  label = paste("COVID19 cases\n"
                                ,scales::comma(totalDailyCases))
            )
            , hjust = 0, nudge_x = 1
            ,colour = "red") +
  geom_point(data = Cov_currentDay
             , aes(x = dayCnt,
                   y = totalDailyCases)
             ,colour = "red") +
  theme_plot +
  coord_cartesian(xlim = c(1, max(t_intr_estm$dayCnt)+50)
                  , ylim = c(1, H1N1_Case_Max$imp_highEst)) +
  
  labs(title = "2009 H1N1 cumulative cases by day vs Covid-19"
       ,subtitle = paste(H1N1_Case_Max$dayCnt,
                         "days after the first case")
       ,y = "Cases"
       ,x = ""
       ,caption = paste("Sources: The New York Times, https://github.com/nytimes/covid-19-data accessed"
                        ,data_Date
                        ,"(Covid19);
       https://www.cdc.gov/h1n1flu/estimates_2009_h1n1.htm (H1N1)")
  )



### Total Deaths ####

sum_US_CoronaVirus %>% 
  ggplot +
  geom_ribbon(data = t_intr_estm %>% 
                filter(Pop_type == "Deaths Total_Deaths") %>% 
                mutate(type = "Deaths"),
              aes(x = dayCnt,
                  ymin = imp_lowEst,
                  ymax = imp_highEst
                  ,group = type
                  ,fill = type
              )
              ,show.legend = FALSE
              ,alpha = .5) +
  geom_errorbar(data = cdcInterpolated %>%
                  filter(X2009H1N1 == "Deaths Total") %>% 
                  select(Pop_type#, type
                         ,EndMonth
                         ,MidLevelRange
                         ,imp_lowEst = lowEst
                         ,imp_highEst = highEst) %>% 
                  separate(Pop_type, c("X2009H1N1", "type"), sep = "_") %>% 
                  inner_join(t_intr_estm %>% 
                               select(EndMonth ,dayCnt))
                ,aes(ymin = imp_lowEst, ymax = imp_highEst
                     ,x =dayCnt
                     ,group = type), width=.2,
                position = position_dodge(.9)
                ,alpha = .4) +
  geom_line(data = t_intr_estm %>% 
              filter(Pop_type == "Deaths Total_Deaths"),
            aes(x = dayCnt
                ,y = imp_MidLevelRange),
            colour = "blue") +
  geom_line(aes(x = dayCnt
                ,y = totalDeaths),
            colour = "red") +
  scale_fill_manual(name = "Type",
                    values = cols) +
  geom_text(data = H1N1_Death_currentDay 
            , aes(x = dayCnt,
                  y = imp_MidLevelRange,
                  label = paste("H1N1 deaths\n"
                                ,scales::comma(imp_MidLevelRange),
                                "\n(mid-range)")
            )
            , hjust = 0, nudge_x = 1
            ,colour = "blue") +
  geom_point(data = H1N1_Death_currentDay
             , aes(x = dayCnt,
                   y = imp_MidLevelRange)
             ,colour = "blue") +
  geom_text(data = Cov_currentDay 
            , aes(x = dayCnt,
                  y = totalDeaths,
                  label = paste("COVID19 deaths\n"
                                ,scales::comma(totalDeaths))
            )
            , hjust = 0, nudge_x = 1
            ,colour = "red") +
  geom_point(data = Cov_currentDay
             , aes(x = dayCnt,
                   y = totalDeaths)
             ,colour = "red") +
  scale_y_log10(label = human_numbers) +
  theme_plot +
  coord_cartesian(xlim = c(1, Cov_currentDay$dayCnt+50)
                  , ylim = c(1, Cov_currentDay$totalDeaths)) +
  annotation_logticks(sides = "l",
                      short = unit(1,"mm"),
                      mid = unit(3,"mm"),
                      long = unit(5,"mm"),
                      size = 0.2, linetype = 1
                      , alpha = .8) +
  labs(title = "2009 H1N1 estimated deaths by day vs Covid-19 deaths"
       ,subtitle = paste(Cov_currentDay$dayCnt,
                         "days after the first case")
       ,y = "Deaths (log scale)"
       ,x = ""
       ,caption = paste("Note: y-axis is in log scale
Sources: The New York Times, https://github.com/nytimes/covid-19-data accessed"
,data_Date
,"(Covid19);
       https://www.cdc.gov/h1n1flu/estimates_2009_h1n1.htm (H1N1)")
  )



sum_US_CoronaVirus %>% 
  ggplot +
  geom_ribbon(data = t_intr_estm %>% 
                filter(Pop_type == "Deaths Total_Deaths") %>% 
                mutate(type = "Deaths"),
              aes(x = dayCnt,
                  ymin = imp_lowEst,
                  ymax = imp_highEst
                  ,group = type
                  ,fill = type
              )
              ,show.legend = FALSE
              ,alpha = .5) +
  geom_errorbar(data = cdcInterpolated %>%
                  filter(X2009H1N1 == "Deaths Total") %>% 
                  select(Pop_type#, type
                         ,EndMonth
                         ,MidLevelRange
                         ,imp_lowEst = lowEst
                         ,imp_highEst = highEst) %>% 
                  separate(Pop_type, c("X2009H1N1", "type"), sep = "_") %>% 
                  inner_join(t_intr_estm %>% 
                               select(EndMonth ,dayCnt)) %>% 
                  distinct()
                ,aes(ymin = imp_lowEst, ymax = imp_highEst
                     ,x =dayCnt
                     ,group = type), width=.2,
                position = position_dodge(.9)
                ,alpha = .4) +
  geom_line(data = t_intr_estm %>% 
              filter(Pop_type == "Deaths Total_Deaths"),
            aes(x = dayCnt
                ,y = imp_MidLevelRange),
            colour = "blue") +
  geom_line(aes(x = dayCnt
                ,y = totalDeaths),
            colour = "red") +
  scale_fill_manual(name = "Type",
                    values = cols) +
  geom_text(data = H1N1_Death_Max 
            , aes(x = dayCnt,
                  y = imp_MidLevelRange,
                  label = paste("H1N1 deaths\n"
                                ,scales::comma(imp_MidLevelRange),
                                "\n(mid-range)")
            )
            , hjust = 0, nudge_x = 1
            ,colour = "blue") +
  geom_point(data = H1N1_Death_Max
             , aes(x = dayCnt,
                   y = imp_MidLevelRange)
             ,colour = "blue") +
  geom_text(data = Cov_currentDay 
            , aes(x = dayCnt,
                  y = totalDeaths,
                  label = paste("COVID19 deaths\n"
                                ,scales::comma(totalDeaths))
            )
            , hjust = 0, nudge_x = 1
            ,colour = "red") +
  geom_point(data = Cov_currentDay
             , aes(x = dayCnt,
                   y = totalDeaths)
             ,colour = "red") +
  scale_y_log10(label = human_numbers) +
  theme_plot +
  coord_cartesian(xlim = c(1, H1N1_Death_Max$dayCnt+50)
                  , ylim = c(1, Cov_currentDay$totalDeaths)) +
  annotation_logticks(sides = "l",
                      short = unit(1,"mm"),
                      mid = unit(3,"mm"),
                      long = unit(5,"mm"),
                      size = 0.2, linetype = 1
                      , alpha = .8) +
  labs(title = "2009 H1N1 estimated deaths by day vs Covid-19 deaths"
       ,subtitle = paste(H1N1_Death_Max$dayCnt,
                         "days after the first case")
       ,y = "Deaths (log scale)"
       ,x = ""
       ,caption = paste("Note: y-axis is in log scale
Sources: The New York Times, https://github.com/nytimes/covid-19-data accessed"
,data_Date
,"(Covid19);
       https://www.cdc.gov/h1n1flu/estimates_2009_h1n1.htm (H1N1)")
  )

# calc change by day ####

try(rm(coronaChange))

coronaChange <- sum_US_CoronaVirus %>%
  mutate(lagCases = lag(totalDailyCases),
         lagDeaths = lag(totalDeaths),
         NewCases = totalDailyCases - lagCases,
         NewDeaths = totalDeaths - lagDeaths,
         NewCases = case_when(is.na(NewCases) ~ totalDailyCases,
                              TRUE ~ NewCases),
         NewDeaths = case_when(is.na(NewDeaths) ~ totalDeaths,
                               TRUE ~ NewDeaths),
         lagNewCases = lag(NewCases),
         lagNewDeaths = lag(NewDeaths),
         changTypeCases = case_when(lagNewCases > NewCases ~ "Decreased",
                                    lagNewCases < NewCases ~ "Increased",
                                    lagNewCases == NewCases ~ "Unchanged",
                                    TRUE ~ "Other"),
         changTypeDeaths = case_when(lagNewDeaths > NewDeaths ~ "Decreased",
                                     lagNewDeaths < NewDeaths ~ "Increased",
                                     lagNewDeaths == NewDeaths ~ "Unchanged",
                                     TRUE ~ "Other")) %>% 
  select(dayCnt, NewCases, NewDeaths, changTypeCases, changTypeDeaths, date) %>% 
  unite("cases", changTypeCases, NewCases, remove = TRUE) %>% 
  unite("deaths", changTypeDeaths, NewDeaths, remove = TRUE) %>% 
  gather(key = "type", value = "cnts", -c(date, dayCnt)) %>% 
  separate(cnts, c("changeType", "Cnt")) %>% 
  mutate(Cnt = as.numeric(Cnt)
         ,date = as.Date(date))

coronaChange <- coronaChange %>% 
  full_join( expand.grid(dayCnt = seq(max(coronaChange$dayCnt)
                                      ,max(t_intr_estm$dayCnt), by = 1),
                         type = c("cases", "deaths") ) %>% 
               group_by(type) %>% 
               mutate( date = seq(max(coronaChange$date)+1, by = "1 day"
                                  ,length.out = max(t_intr_estm$dayCnt)-max(coronaChange$dayCnt)+1
               ))  %>% ungroup  
  ) %>% 
  mutate( Cnt = replace_na(Cnt, 0),
          changeType = replace_na(changeType, "Other"),
          dataSet = "Coronavirus") 

H1N1Change <- t_intr_estm %>% 
  select(dayCnt, Pop_type, imp_MidLevelRange) %>%
  filter( grepl(" Total_", Pop_type)) %>% 
  arrange(dayCnt) %>% 
  group_by(Pop_type) %>%
  mutate(lagimp_MidLevelRange = lag(imp_MidLevelRange),
         newNumber = imp_MidLevelRange - lagimp_MidLevelRange,
         lagNewNumber = lag(newNumber),
         changTypeCases = case_when(lagNewNumber > newNumber ~ "Decreased",
                                    lagNewNumber < newNumber ~ "Increased",
                                    lagNewNumber == newNumber ~ "Unchanged",
                                    TRUE ~ "Other"),
         type = case_when(grepl("Cases", Pop_type) ~ "cases",
                          grepl("Deaths", Pop_type) ~ "deaths",
                          grepl("Hospitalizations", Pop_type) ~ "hospitalizations"),
         dataSet = "H1N1"
  ) %>%
  ungroup() %>% 
  mutate(newNumber = replace_na(newNumber, 0)) %>% 
  select(dayCnt, Cnt = newNumber
         ,  changeType = changTypeCases, type, dataSet) %>% 
  inner_join(data.frame  (dayCnt = seq(1, 336, by = 1),
                          date = seq(min(cdcInterpolated$EndMonth),
                                     max(cdcInterpolated$EndMonth), by = "1 day")  )
  )

load("dat_Hldy.Rdata")

Hldy <- sum_US_CoronaVirus %>% 
  left_join( dat_Hldy %>% 
               filter(grepl("Federal", Type) , !grepl("observed$", Name)) %>% 
               select(HOL_Crn = Name, date = EndMonth) %>% 
               mutate(date = as.character(date)) 
  ) %>%
  select(dayCnt, HOL_Crn) %>% 
  full_join(
    t_intr_estm %>% 
      left_join( dat_Hldy %>% 
                   filter(grepl("Federal", Type) , !grepl("observed$", Name)) %>% 
                   select(HOL_H1N1 = Name,  EndMonth) 
      ) %>%
      select(dayCnt, HOL_H1N1) 
  )

Hldy %>%
  count(dayCnt = case_when(is.na(dayCnt) ~ "0", TRUE ~ "1"),
        HOL_Crn = case_when(is.na(HOL_Crn) ~ "0", TRUE ~ "1"),
        HOL_H1N1 = case_when(is.na(HOL_H1N1) ~ "0", TRUE ~ "1"))

verticalLines <- coronaChange %>% 
  bind_rows(H1N1Change) %>% 
  filter(type == "cases") %>% 
  select(dataSet, date, dayCnt) %>% 
  mutate(qrt = cut(date, "quarter", right = TRUE),
         twoMo = cut(date, breaks = '2 month')) %>% 
  group_by(dataSet, twoMo) %>% 
  slice(1) %>% 
  filter(dayCnt != 1) %>% 
  ungroup() %>% 
  select(dataSet, date ,dayCnt) %>% 
  mutate(vline = dayCnt)

coronaChange %>% 
  bind_rows(H1N1Change) %>% 
  filter(type == "cases") %>% 
  mutate(changeType = fct_relevel(changeType, "Other", after = Inf) 
  ) %>% 
  #left_join() %>% 
  ggplot() +
  geom_vline(data = verticalLines
             ,aes(xintercept = vline),
             color = "blue", size = .5
             ,alpha = .8) +
  geom_text(data = verticalLines %>% 
              mutate(posY = case_when(dataSet == "H1N1" ~ 
                                        max(H1N1Change$Cnt, na.rm = TRUE) - 5000,
                                      TRUE ~ max(coronaChange$Cnt, na.rm = TRUE) - 1000))
            ,aes(x = vline
                 ,y = posY
                 ,label = format(date, "%b %Y")),
            hjust = 0,
            vjust = -1.50, 
            angle = 0, 
            size = 3 
            ,colour = "blue") +
  geom_col(aes(x = dayCnt, y = Cnt, 
               fill = changeType), alpha = .8) +
  scale_y_continuous(label = human_numbers
                     ,expand = expansion(mult = c(0, .1))
  ) +
  #scale_x_continuous()
  scale_fill_brewer(name = "Change Type"
                    ,palette = "Set1"
                    ,direction = -1) +
  facet_wrap(~dataSet,
             ncol = 1
             ,scales = "free") +
  #coord_cartesian(xlim = c(1, 336) #, ylim = c(0, 50000)
  # ) +
  theme_plot +
  labs(title = "2009 H1N1 new cases by day vs Covid-19 cases"
       ,subtitle = "336 days after the first case
       Vertical blue lines are for reference and placed every two months
       after the frst case for each pandemic"
       ,y = "Cases"
       ,x = ""
       ,caption = paste("Sources: The New York Times, https://github.com/nytimes/covid-19-data accessed"
                        ,data_Date
                        ,"(Covid19);
       https://www.cdc.gov/h1n1flu/estimates_2009_h1n1.htm (H1N1)")
  )

coronaChange %>% 
  bind_rows(H1N1Change) %>% 
  filter(type == "deaths") %>% 
  mutate(changeType = fct_relevel(changeType, "Other", after = Inf) 
  ) %>% 
  ggplot() +
  geom_vline(data = verticalLines
             ,aes(xintercept = vline),
             color = "blue", size = .5,
             alpha = .8) +
  geom_text(data = verticalLines %>% 
              mutate(posY = case_when(dataSet == "H1N1" ~ H1N1Change %>% 
                                        filter(type == 'deaths') %>% .$Cnt %>% 
                                        max(),
                                      TRUE ~ coronaChange %>% 
                                        filter(type == 'deaths') %>% .$Cnt %>% 
                                        max()))
            ,aes(x = vline
                 ,y = posY
                 ,label = format(date, "%b %Y")),
            hjust = 0,
            vjust = -1.50, 
            angle = 0, 
            size = 3 
            ,colour = "blue") +
  geom_col(aes(x = dayCnt,  y = Cnt,
               fill = changeType), alpha = .8) +
  scale_y_continuous(label = human_numbers
                     ,expand = expansion(mult = c(0, .1))
  ) +
  scale_fill_brewer(name = "Change Type"
                    ,palette = "Set1"
                    ,direction = -1) +
  facet_wrap(~dataSet,
             ncol = 1
             ,scales = "free") +
  theme_plot +
  #coord_cartesian(xlim = c(1, 336) #, ylim = c(0, 50000)
  # ) + 
  labs(title = "2009 H1N1 new deaths by day vs Covid-19 deaths"
       ,subtitle = "336 days after the first case
       Vertical blue lines are for reference and placed every two months
       after the frst case for each pandemic"
       ,y = "New deaths"
       ,x = ""
       ,caption = paste("Sources: The New York Times, https://github.com/nytimes/covid-19-data accessed"
                        ,data_Date
                        ,"(Covid19);
       https://www.cdc.gov/h1n1flu/estimates_2009_h1n1.htm (H1N1)")
  )

CoronaCases <- coronaChange %>% 
  filter(type == "cases") %>% 
  mutate(Cnt = na_if(Cnt, 0))

dates <- ymd(CoronaCases$date)
values <- CoronaCases$Cnt

plotCases <- calendarHeatmap(dates
                             , values
                             , title = "COVID 19 Cases in the US"
                             , subtitle = ""
                             , legendtitle = "Cases")

CoronaDeaths <- coronaChange %>% 
  filter(type == "deaths") %>% 
  mutate(Cnt = na_if(Cnt, 0))

dates <- ymd(CoronaDeaths$date)
values <- CoronaDeaths$Cnt

plotDeaths <- calendarHeatmap(dates
                              , values
                              , title = "COVID 19 Deaths in the US"
                              , subtitle = ""
                              , legendtitle = "Deaths")


library(gridExtra)

grid.arrange(plotCases, plotDeaths, nrow = 2)

# print trend lines

countyTrends <- US_CoronaVirus %>% 
  filter(grepl("^6071|^6059|^6065|^6037", fips)) %>% 
  mutate(date = as.Date(date)) %>% 
  arrange(fips, date) %>% 
  group_by(fips, county) %>% 
  mutate(newCases = lag(cases),
         newCases = cases - newCases) %>% 
  ungroup() %>% 
  as.data.table() %>% 
  .[, rollingMean07Day := frollmean(newCases, 7, na.rm = T), by = fips] %>%
  .[, rollingMean14Day := frollmean(newCases, 14, na.rm = T), by = fips] %>%
  pivot_longer(-c(date, county, state, fips), names_to = "variable", values_to = "count")

maxRollingValues <- countyTrends %>% 
  group_by(fips, variable) %>% 
  filter(date == max(date)) %>% 
  ungroup

ggplot() +
  geom_col(data = countyTrends %>% 
             filter(variable == "newCases"),
           aes(x = date, y = count )) +
  geom_line(data = countyTrends %>% 
              filter(grepl("rollingMean",variable)),
            aes(x = date, y = count
                ,color = variable)
  ) +
  facet_wrap(~county, ncol = 1) + 
  scale_x_date(expand = expansion(mult = c(.1, .2))) +
  # geom_text(data = dat %>% 
  #             filter(cat == "newCases")
  #           ,aes(x = date, y = count, label = scales::comma(count, accuracy = 1)),
  #           size = 3,alpha = .8) +
  geom_point(data = maxRollingValues %>% 
               filter(grepl("rollingMean",variable)),
             aes(x = date, y = count
                 ,color = variable )
             ,alpha = .8
  ) +
  ggrepel::geom_text_repel(data = maxRollingValues %>% 
                             filter(grepl("rollingMean",variable)) %>% 
                             mutate(label = scales::comma(count, accuracy = 1))
                           ,aes(x =  date #+ 20
                                , y = count,
                                color = variable,
                                label = label
                           )
                           ,show.legend = FALSE,
                           size = 3,
                           force             = 0.5,
                           nudge_x           = 0.15,
                           hjust             = -1,
                           segment.size  = 0.2,
                           segment.color = "grey50",
                           direction     = "y"
  ) +
  scale_colour_manual(values = c("rollingMean07Day" = "darkgoldenrod4", "rollingMean14Day" = "seagreen")) +
  theme_plot +
  labs(title = "Rates by Counties"
       ,subtitle = "New cases, 7 and 14 days rolling average "
       ,y = "Cases"
       ,x = ""
       ,caption = paste("Sources: The New York Times, https://github.com/nytimes/covid-19-data accessed"
                        ,data_Date
                        ,"(Covid19)")
  )

# new cases per population

# new cases per population

newCasesCounties <- countyTrends %>% 
  filter(grepl("rollingMean",variable)) %>% 
  # filter(fips == "6037") %>% 
  left_join( counties_2018acs %>% filter(variable == "B01003_001") %>%
               select(fips  =GEOID, estimate) %>% 
               mutate(fips = as.numeric(fips))
  ) %>% 
  mutate(count = replace_na(count, 0),
         casesPer100K = (count/estimate ) * 100000) %>% 
  select(-c(count, estimate)) %>% 
  group_by(fips) %>% 
  pivot_wider(names_from = variable, values_from = casesPer100K) %>% 
  mutate(diff_07Day_mns_14day = rollingMean07Day - rollingMean14Day,
         previusDay = lag( date, order_by = date )) %>% 
  ungroup

ggplot() +
  geom_rect(data = newCasesCounties
            , aes(xmin = previusDay, xmax = date
                  , ymin = -Inf, ymax = Inf
                  , fill = diff_07Day_mns_14day),
            alpha = scales::rescale(newCasesCounties$diff_07Day_mns_14day) # 0.75
            , colour = NA
  ) +
  scale_fill_distiller(name = "Difference between\n7 and 14 days rolling average"
                       ,palette = "Spectral") +
  geom_line(data = countyTrends %>% 
              filter(grepl("rollingMean",variable)) %>% 
              left_join( counties_2018acs %>% filter(variable == "B01003_001") %>%
                           select(fips = GEOID, estimate) %>% 
                           mutate(fips = as.numeric(fips))
              ) %>% 
              mutate(count = replace_na(count, 0),
                     casesPer100K = (count/estimate ) * 100000),
            aes(x = date, y = casesPer100K
                ,color = variable)
  ) +
  facet_wrap(~county, ncol = 1) + 
  scale_y_continuous(expand = expansion(mult = c(0, .15))) +
  scale_x_date(expand = expansion(mult = c(.1, .2))) +
  scale_colour_manual(name = "Rolling Average",
                      labels = c("7-day","14-day"),
                      values = c("rollingMean07Day" = "darkgoldenrod4", "rollingMean14Day" = "seagreen")) +
  theme_plot +
  geom_point(data = countyTrends %>% 
               filter(grepl("rollingMean",variable)) %>% 
               group_by(fips, variable) %>% 
               filter(date == max(date)) %>% 
               ungroup %>%
               left_join( counties_2018acs %>%
                            filter(variable == "B01003_001") %>%
                            select(fips = GEOID, estimate) %>% 
                            mutate(fips = as.numeric(fips))
               ) %>% 
               mutate(count = replace_na(count, 0),
                      casesPer100K = (count/estimate ) * 100000)
             ,
             aes(x = date, y = casesPer100K
                 ,color = variable )
             ,alpha = .8
  ) +
  ggrepel::geom_text_repel(data = countyTrends %>% 
                             filter(grepl("rollingMean",variable)) %>% 
                             group_by(fips, variable) %>% 
                             filter(date == max(date)) %>% 
                             ungroup %>%
                             left_join( counties_2018acs %>% 
                                          filter(variable == "B01003_001") %>% 
                                          select(fips  =GEOID, estimate) %>% 
                                          mutate(fips = as.numeric(fips))
                             ) %>% 
                             mutate(count = replace_na(count, 0),
                                    casesPer100K = (count/estimate ) * 100000)
                           
                           # mutate(label = scales::comma(count, accuracy = 1))
                           ,aes(x =  date #+ 20
                                , y = casesPer100K,
                                color = variable,
                                label = paste0(scales::comma(casesPer100K, accuracy = 0.1)
                                               ," or ",
                                               prettyFractions(casesPer100K/100000))
                           )
                           ,show.legend = FALSE,
                           size = 3,
                           force             = 0.5,
                           nudge_x           = 0.15,
                           hjust             = -1,
                           segment.size  = 0.2,
                           segment.color = "grey50",
                           direction     = "y"
  ) +
  labs(title = "Rates by Counties by 100K population"
       ,subtitle = "New cases, 7 and 14 days rolling average "
       ,y = "Cases"
       ,x = ""
       ,caption = paste("Sources: The New York Times, https://github.com/nytimes/covid-19-data accessed"
                        ,data_Date
                        ,"(Covid19)")
  )

if(FALSE) {
  
  library(benford.analysis) 
  
  bfd.cp <- countyTrends %>% 
    filter(grepl("cases",variable)) %>% 
    filter(fips == "6037") %>% 
    .$count %>% 
    benford(.)
  
  bfd.cp$stats$chisq$p.value
  
  start_time = Sys.time()
  
  doExpectedValues = function(sel_name) {
    
    print(sel_name)
    
    bfd.cp <- US_CoronaVirus %>% 
      filter(fips == sel_name ) %>% 
      .$cases %>% 
      benford(.)
    
    bfd.cp$stats$chisq %>% unlist %>% enframe %>% 
      mutate(fips = sel_name)
    
  }
  
  testdataExpected <- lapply(US_CoronaVirus$fips %>% .[!is.na(.)] %>% 
                               unique, doExpectedValues)
  
  Category_names <- unique(US_CoronaVirus$fips %>% .[!is.na(.)] %>% 
                             unique)
  
  Sys.time() - start_time # Time difference of 1.163981 mins
  
  bfd.cp_p_vals <- testdataExpected %>% 
    data.table::rbindlist(., fill = TRUE, idcol= "iteration") %>% 
    left_join( US_CoronaVirus %>% 
                 distinct(county, state, fips))  %>% 
    filter(grepl("p.valu", name)) %>% 
    select(value :state) %>% 
    mutate(five_pcnt = ifelse(value <=.05,"Less_Or_equal_.05","over _.05")) %>% 
    .[,  state_cnty := .N, by = state] %>% 
    .[,  cnty_type := .N, by = c("five_pcnt", "state")] %>% 
    distinct(state, five_pcnt, state_cnty, cnty_type) %>% 
    mutate(state_countyTypes = cnty_type/state_cnty) %>% 
    select(state , state_cnty, five_pcnt, state_countyTypes) %>% 
    pivot_wider(names_from = five_pcnt, values_from = state_countyTypes) %>% 
    arrange(state) %>% 
    mutate(state_rank = row_number(Less_Or_equal_.05),
           state_rank = nrow(.) - state_rank) %>% 
    arrange(state_rank)
  
}


countyPop <- counties_2018acs %>% 
  filter(variable == "B01003_001") %>% 
  #head(500) %>% 
  mutate(state = sub('.*,', '', NAME),
         state = trimws(state),
         fips = substr(GEOID, start = 1, stop = 2) ) %>% 
  group_by(state, fips) %>% 
  summarize(st_pop = sum(estimate, na.rm = TRUE)) %>% 
  full_join(US_StCoronaVirus %>% 
              mutate( fips = str_pad(fips, 2, pad = "0"))
  ) %>% 
  mutate(casesPer1K = (cases/st_pop ) * 1000,
         #casesPer1K = round(casesPer1K, 0),
         date = as.Date(date)) %>% 
  left_join(data.frame(state = state.name,
                       state_region = state.region,
                       state_abb = state.abb)
  )

max_region <- countyPop %>% 
  group_by(fips) %>%
  arrange(desc(casesPer1K)) %>% 
  slice(1) %>% 
  ungroup() %>% 
  group_by(state_region) %>%
  arrange(desc(casesPer1K)) %>% 
  slice(1:4) %>% 
  ungroup() %>% 
  filter(!is.na(state_abb))

# RColorBrewer::display.brewer.all()

mycolors <- colorRampPalette(RColorBrewer::brewer.pal(8, "Accent"))(length(unique(max_region$state))) %>% 
  sub("#FEF295", "#31a354",.)

p <- ggplot() +
  geom_line(data = countyPop %>% 
              select( fips,
                      date,
                      state1 = state,
                      state_region,
                      casesPer1K) %>% 
              filter(!is.na(state_region))
            ,aes(x =  date
                 , y = casesPer1K,
                 group = state1)
            , color = "grey"
            ,alpha = .5
            ,show.legend = FALSE) +
  facet_wrap(~ state_region
             ,scales = "fixed") +
  geom_line(data = countyPop %>% 
              select( fips,
                      date,
                      state1 = state,
                      state_region,
                      casesPer1K) %>% 
              filter(!is.na(state_region)) %>% 
              semi_join( max_region %>% 
                           select( fips,
                                   state)
              )
            ,aes(x =  date
                 , y = casesPer1K,
                 color = state1),
            ,alpha = .8
            ,show.legend = FALSE) +
  geom_point(data = countyPop %>% 
               select( fips,
                       date,
                       state1 = state,
                       state_region,
                       casesPer1K) %>%
               filter(date == max(date) ) %>% 
               filter(!is.na(state_region)) %>% 
               semi_join( max_region %>% 
                            select( fips,
                                    state)
               )
             ,aes(x =  date
                  , y = casesPer1K,
                  color = state1),
             , size = 1
             , stroke = .03
             , shape = 21
             , alpha = .5
             ,show.legend = FALSE) +
  scale_x_date(expand = expansion(mult = c(.1, .4))) +
  scale_y_continuous(#label = human_numbers,
    expand = expansion(mult = c(0, .1))
  ) +
  scale_color_manual(values = mycolors)

p +
  ggrepel::geom_text_repel(data = countyPop %>% 
                             select( fips,
                                     date,
                                     state1 = state,
                                     state_region,
                                     casesPer1K,
                                     state_abb) %>%
                             filter(date == max(date) ) %>% 
                             filter(!is.na(state_region)) %>% 
                             semi_join( max_region %>% 
                                          select( fips,
                                                  state)
                             ) %>% 
                             droplevels() %>% 
                             mutate(label = paste0(state_abb
                                                   ," ", scales::comma(casesPer1K, accuracy = 0.1)
                                                   ," or "
                                                   ,prettyFractions(casesPer1K/1000)))
                           ,aes(x =  date #+ 20
                                , y = casesPer1K,
                                color = state1,
                                label = label
                           )
                           ,show.legend = FALSE,
                           size = 3,
                           force             = 0.5,
                           nudge_x           = 0.15,
                           hjust             = -1,
                           segment.size  = 0.2,
                           segment.color = "grey50",
                           direction     = "y"
  ) +
  theme_plot +
  labs(title = "Cummulative cases per 1k persons by state region",
       subtitle = "the four highest states by region are highlighted",
       y = "",
       x = "",
       caption = paste("Sources: The New York Times, https://github.com/nytimes/covid-19-data accessed"
                       ,data_Date
                       ,"(Covid19)\nU.S. Census Bureau; American Community Survey, 2014-2018 5-year Estimates,\nTable B01003_001 TOTAL POPULATION; generated with tidycensus R package.")
  )

# daily cases by state region

countyPop <- counties_2018acs %>% 
  filter(variable == "B01003_001") %>% 
  #head(500) %>% 
  mutate(state = sub('.*,', '', NAME),
         state = trimws(state),
         fips = substr(GEOID, start = 1, stop = 2) ) %>% 
  group_by(state, fips) %>% 
  summarize(st_pop = sum(estimate, na.rm = TRUE)) %>% 
  full_join( US_StCoronaVirus %>% 
               mutate( fips = str_pad(fips, 2, pad = "0")) %>% 
               group_by(state ) %>% 
               mutate( dailyCases = cases - lag(cases, order_by = date ))
  ) %>% 
  ungroup %>% 
  as.data.table() %>% 
  .[, rollingMean07Day := frollmean(dailyCases, 7, na.rm = T), by = fips] %>%
  .[, rollingMean14Day := frollmean(dailyCases, 14, na.rm = T), by = fips] %>% 
  mutate(dailyRolling7Day = (rollingMean07Day/st_pop ) * 100000,
         #casesPer1K = round(casesPer1K, 0),
         date = as.Date(date)) %>% 
  left_join(data.frame(state = state.name,
                       state_region = state.region,
                       state_abb = state.abb)
  )

max_region <- countyPop %>% 
  group_by(fips) %>%
  arrange(desc(date)) %>% 
  slice(1) %>% 
  ungroup() %>% 
  group_by(state_region) %>%
  arrange(desc(dailyRolling7Day)) %>% 
  slice(1:4) %>% 
  ungroup() %>% 
  filter(!is.na(state_abb))

# RColorBrewer::display.brewer.all()

mycolors <- colorRampPalette(RColorBrewer::brewer.pal(8, "Accent"))(length(unique(max_region$state))) %>% 
  sub("#FEF295", "#31a354",.)

p <- ggplot() +
  geom_line(data = countyPop %>% 
              select( fips,
                      date,
                      state1 = state,
                      state_region,
                      dailyRolling7Day) %>% 
              filter(!is.na(state_region))
            ,aes(x =  date
                 , y = dailyRolling7Day,
                 group = state1)
            , color = "grey"
            ,alpha = .5
            ,show.legend = FALSE) +
  facet_wrap(~ state_region
             ,scales = "fixed") +
  geom_line(data = countyPop %>% 
              select( fips,
                      date,
                      state1 = state,
                      state_region,
                      dailyRolling7Day) %>% 
              filter(!is.na(state_region)) %>% 
              semi_join( max_region %>% 
                           select( fips,
                                   state)
              )
            ,aes(x =  date
                 , y = dailyRolling7Day,
                 color = state1),
            ,alpha = .8
            ,show.legend = FALSE) +
  geom_point(data = countyPop %>% 
               select( fips,
                       date,
                       state1 = state,
                       state_region,
                       dailyRolling7Day) %>%
               filter(date == max(date) ) %>% 
               filter(!is.na(state_region)) %>% 
               semi_join( max_region %>% 
                            select( fips,
                                    state)
               )
             ,aes(x =  date
                  , y = dailyRolling7Day,
                  color = state1),
             , size = 1
             , stroke = .03
             , shape = 21
             , alpha = .5
             ,show.legend = FALSE) +
  scale_x_date(expand = expansion(mult = c(.1, .5))) +
  scale_y_continuous(#label = human_numbers,
    expand = expansion(mult = c(0, .1))
  ) +
  scale_color_manual(values = mycolors)

p +
  ggrepel::geom_text_repel(data = countyPop %>% 
                             select( fips,
                                     date,
                                     state1 = state,
                                     state_region,
                                     dailyRolling7Day,
                                     state_abb) %>%
                             filter(date == max(date) ) %>% 
                             filter(!is.na(state_region)) %>% 
                             semi_join( max_region %>% 
                                          select( fips,
                                                  state)
                             ) %>% 
                             droplevels() %>% 
                             mutate(label = paste0(state_abb
                                                   ," ", scales::comma(dailyRolling7Day, accuracy = 0.1)
                                                   ," or "
                                                   ,prettyFractions(dailyRolling7Day/100000)))
                           ,aes(x =  date #+ 20
                                , y = dailyRolling7Day,
                                color = state1,
                                label = label
                           )
                           ,show.legend = FALSE,
                           size = 3,
                           force             = 0.5,
                           nudge_x           = 0.15,
                           hjust             = -1,
                           segment.size  = 0.2,
                           segment.color = "grey50",
                           direction     = "y"
  ) +
  theme_plot +
  labs(title = "7-day rolling average of daily cases per 100k persons by state region",
       subtitle = "the four highest states by region are highlighted",
       y = "",
       x = "",
       caption = paste("Sources: The New York Times, https://github.com/nytimes/covid-19-data accessed"
                       ,data_Date
                       ,"(Covid19)\nU.S. Census Bureau; American Community Survey, 2014-2018 5-year Estimates,\nTable B01003_001 TOTAL POPULATION; generated with tidycensus R package.")
  )

# now all Calif counties

Ca_abbv_counties <- "https://sv08data.dot.ca.gov/contractcost/map.html" %>%
  xml2::read_html() %>%
  rvest::html_table() %>% 
  as.data.frame() %>% 
  setNames(gsub("[^[:alnum:]]", perl = TRUE, "", names(.)))

CalifCounties <- US_CoronaVirus %>% 
  filter(state == "California") %>% 
  mutate(GEOID = str_pad(fips, 5, pad = "0")) %>% 
  inner_join( counties_2018acs %>% 
                filter(variable == "B01003_001") %>% 
                filter(grepl("California", NAME))
  ) %>% 
  mutate(casesPer1K = (cases/estimate )* 1000,
         #casesPer1K = round(casesPer1K, 0),
         date = as.Date(date)) %>% 
  left_join(Ca_abbv_counties %>% 
              select(county = COUNTY, ABBREV)
  )

selectedCounties <- CalifCounties %>% 
  group_by(fips) %>% 
  filter(date == max(date)) %>% 
  arrange(desc(casesPer1K)) %>% 
  .$county %>% .[1:grep("^Riverside", .)] %>% 
  c("Ventura","Santa Barbara","San Francisco","San Bernardino","Riverside","Kern","Imperial","San Diego","Orange","Los Angeles","Kings","Tulare","Marin") %>% 
  unique %>% sort %>%
  paste0(., collapse = "|")

cntCouties <- selectedCounties %>% 
  strsplit(.,"\\|") %>% 
  unlist %>% 
  length()

getPalette <- colorRampPalette(RColorBrewer::brewer.pal( cntCouties, "Set1"))

lcols <- getPalette(cntCouties) %>% sub("#FFF52F", "#5e3c99", .)

p <- ggplot() +
  geom_line(data = CalifCounties
            ,aes(x =  date
                 , y = casesPer1K,
                 group = county)
            , color = "grey"
            ,alpha = .5
            ,show.legend = FALSE) +
  geom_line(data = CalifCounties %>% 
              filter(grepl(selectedCounties
                           , county ))
            ,aes(x =  date
                 , y = casesPer1K,
                 color = county),
            ,alpha = .8
            ,show.legend = FALSE) +
  geom_point(data = CalifCounties %>% 
               filter(grepl(selectedCounties
                            , county ))  %>% 
               filter(date == max(date) )
             ,aes(x =  date
                  , y = casesPer1K,
                  color = county),
             , size = 1
             , stroke = .1
             , shape = 21
             , alpha = .5
             ,show.legend = FALSE) +
  scale_x_date(expand = expansion(mult = c(.1, .3))) +
  scale_y_continuous(#label = human_numbers,
    expand = expansion(mult = c(0, .1))
  ) +
  scale_color_manual(values = lcols )

p +
  ggrepel::geom_text_repel(data = CalifCounties %>% 
                             filter(grepl(selectedCounties, county )) %>% 
                             filter(date == max(date) ) %>% 
                             droplevels() %>% 
                             mutate(label = paste0(ABBREV
                                                   ," ", scales::comma(casesPer1K, accuracy = 0.1)
                                                   ," or "
                                                   ,prettyFractions(casesPer1K/1000)))
                           ,aes(x =  date #+ 20
                                , y = casesPer1K,
                                color = county,
                                label = label
                           )
                           
                           ,show.legend = FALSE,
                           size = 3,
                           force             = 0.5,
                           nudge_x           = 0.15,
                           hjust             = -1,
                           segment.size  = 0.2,
                           segment.color = "grey50",
                           direction     = "y"
  ) +
  labs(title = "Cummulative cases per 1k persons for California counties",
       subtitle = "selected counties highlighted",
       y = "",
       x = "",
       caption = paste("Sources: The New York Times, https://github.com/nytimes/covid-19-data accessed"
                       ,data_Date
                       ,"(Covid19)\nU.S. Census Bureau; American Community Survey, 2014-2018 5-year Estimates,\nTable B01003_001 TOTAL POPULATION; generated with tidycensus R package.")
  )

# calif 7-da7 rollling avg new cases

CalifCounties <- US_CoronaVirus %>% 
  filter(state == "California") %>% 
  mutate(GEOID = str_pad(fips, 5, pad = "0")) %>% 
  group_by(fips ) %>% 
  mutate( dailyCases = cases - lag(cases, order_by = date )) %>% 
  as.data.table() %>% 
  .[, rollingMean07Day := frollmean(dailyCases, 7, na.rm = T), by = fips] %>%
  .[, rollingMean14Day := frollmean(dailyCases, 14, na.rm = T), by = fips] %>% 
  inner_join( counties_2018acs %>% 
                filter(variable == "B01003_001") %>% 
                filter(grepl("California", NAME))
  ) %>% 
  mutate(dailyRolling7Day = (rollingMean07Day/estimate )* 100000,
         date = as.Date(date)) %>% 
  left_join(Ca_abbv_counties %>% 
              select(county = COUNTY, ABBREV)
  )

selectedCounties <- CalifCounties %>% 
  group_by(fips) %>% 
  filter(date == max(date)) %>% 
  arrange(desc(dailyRolling7Day)) %>% 
  .$county %>% .[1:grep("^Riverside", .)] %>% 
  c("Ventura","Santa Barbara","San Francisco","San Bernardino","Riverside","Kern","Imperial","San Diego","Orange","Los Angeles","Kings","Tulare","Marin") %>% 
  unique %>% sort %>%
  paste0(., collapse = "|")

cntCouties <- selectedCounties %>% 
  strsplit(.,"\\|") %>% 
  unlist %>% 
  length()

getPalette <- colorRampPalette(RColorBrewer::brewer.pal( cntCouties, "Set1"))

lcols <- getPalette(cntCouties) %>% sub("#FFF52F", "#5e3c99", .)

p <- ggplot() +
  geom_line(data = CalifCounties
            ,aes(x =  date
                 , y = dailyRolling7Day,
                 group = county)
            , color = "grey"
            ,alpha = .5
            ,show.legend = FALSE) +
  geom_line(data = CalifCounties %>% 
              filter(grepl(selectedCounties
                           , county ))
            ,aes(x =  date
                 , y = dailyRolling7Day,
                 color = county),
            ,alpha = .8
            ,show.legend = FALSE) +
  geom_point(data = CalifCounties %>% 
               filter(grepl(selectedCounties
                            , county ))  %>% 
               filter(date == max(date) )
             ,aes(x =  date
                  , y = dailyRolling7Day,
                  color = county),
             , size = 1
             , stroke = .1
             , shape = 21
             , alpha = .5
             ,show.legend = FALSE) +
  scale_x_date(expand = expansion(mult = c(.1, .3))) +
  scale_y_continuous(#label = human_numbers,
    expand = expansion(mult = c(0, .1))
  ) +
  scale_color_manual(values = lcols )

p +
  ggrepel::geom_text_repel(data = CalifCounties %>% 
                             filter(grepl(selectedCounties, county )) %>% 
                             filter(date == max(date) ) %>% 
                             droplevels() %>% 
                             mutate(label = paste0(ABBREV
                                                   ," ", scales::comma(dailyRolling7Day, accuracy = 0.1)
                                                   ," or "
                                                   ,prettyFractions(dailyRolling7Day/100000)))
                           ,aes(x =  date #+ 20
                                , y = dailyRolling7Day,
                                color = county,
                                label = label
                           )
                           ,show.legend = FALSE,
                           size = 3,
                           force             = 0.5,
                           nudge_x           = 0.15,
                           hjust             = -1,
                           segment.size  = 0.2,
                           segment.color = "grey50",
                           direction     = "y"
  ) +
  labs(title = "7-day rolling average of daily cases per 100k persons by California counties",
       subtitle = "selected counties highlighted",
       y = "",
       x = "",
       caption = paste("Sources: The New York Times, https://github.com/nytimes/covid-19-data accessed"
                       ,data_Date
                       ,"(Covid19)\nU.S. Census Bureau; American Community Survey, 2014-2018 5-year Estimates,\nTable B01003_001 TOTAL POPULATION; generated with tidycensus R package.")
  )



if(FALSE) {
  
  rm(list = ls()) #start with empty workspace
  
  load("wklyCnts.RData")
  
  wklyCnts_t <- wklyCnts %>% 
    #filter(grepl("09.07.2018|Weekly-ILI-Report-2020.01.06.pdf", file)) %>% 
    mutate(PcntNum = gsub("[^[:digit:]\\.]", "", Pcnt),
           PcntNum = as.numeric(PcntNum)/100) %>% 
    filter(PcntNum < 1) %>% 
    mutate(test = scales::percent(PcntNum
                                  ,decimal.mark = "."),
           dateFile =  gsub("[^[:digit:]]", " ", file),
           dateFile = sub("\\s+?(\\d* \\d* \\d*)\\.?\\s+.*$", "\\1", dateFile),
           dateFile = sub('(\\w+\\s+\\w+\\s+\\w+\\s+\\w+).*$', '\\1', dateFile),
           dateFile = sub("(\\d{1,} \\d{1,} \\d{1,}).*", "\\1", dateFile),
           dateFile = trimws(dateFile), 
           dateFile = case_when(grepl(".*\\d{4}$", dateFile) ~ as.Date(dateFile, format = "%m %d %Y"),
                                grepl("^\\d{4}", dateFile) ~ as.Date(dateFile, format = "%Y %m %d"),
                                TRUE ~ as.Date(dateFile, format = "%m %d %y")),
           dateFile_Year_month = format(dateFile, "%Y-%m")) %>% 
    separate(Week, c("begWeek", "endWeek"), "-", extra = "merge") %>%
    separate(Yr, c("begYr", "endYr"), "-", extra = "merge", remove = FALSE) %>% 
    distinct() %>% 
    mutate(start = paste(Yr, begWeek) %>% as.Date(., format = "%Y %m/%d"),
           end = paste(Yr, endWeek) %>% as.Date(., format = "%Y %m/%d"),
           YearWeek = format(start, "%Y-%U"),
           diff_days = difftime(start, end) %>% as.numeric(),
           start_weekDay = format(start, "%a"),
           Finalstart = case_when(is.na(YearWeek) & as.numeric(MMWRWeek) > 40
                                  ~ paste(begYr, MMWRWeek, "7", sep = "-") %>%
                                    as.Date(., format = "%Y-%U-%u"),
                                  is.na(YearWeek) & as.numeric(MMWRWeek) < 40
                                  ~ paste(endYr, MMWRWeek, "7", sep = "-") %>%
                                    as.Date(., format = "%y-%U-%u"),
                                  TRUE ~ start),
           FinalstartWeek = format(Finalstart, "%Y-%U"),
           FinalstartWeekYear = format(Finalstart, "%Y"),
           final_MMWRWeek = case_when(is.na(MMWRWeek) ~
                                        format(start, "%U") %>% as.numeric,
                                      TRUE ~ as.numeric(MMWRWeek) )) #%>% select(-file)
  
  theme_set(theme_bw())
  
  wklyCnts_t  %>% 
    ggplot() +
    geom_line( aes(x = Finalstart, y = PcntNum, color = begYr),
               alpha = .5) +
    geom_point( aes(x = Finalstart, y = PcntNum, color = begYr),
                alpha = .5) + 
    # geom_text(aes(x = Finalstart, y = PcntNum, label = FinalstartWeek),
    #           alpha = .2,
    #           size = 5) +
    theme(legend.position = "top")
  
  wklyCnts_t  %>% # some pcnts are dif eg week 2017-48 has more than one value reported
    arrange(desc(iteration)) %>%
    group_by(Finalstart, final_MMWRWeek) %>%
    slice(1) %>%
    ggplot() +
    geom_line( aes(x = Finalstart, y = PcntNum
                   #, color = begYr
    ),
    alpha = .5) +
    geom_point( aes(x = Finalstart, y = PcntNum
                    #, color = begYr
    ),
    alpha = .5) + 
    scale_x_date( date_labels = "%Y-%U"
                  ,  breaks = '4 weeks') +
    theme(legend.position = "top"
          ,axis.text.x = element_text(angle = 90, hjust = 1))
  
  wklyCnts_t  %>% # some pcnts are dif eg week 2017-48 has more than one value reported
    arrange(desc(iteration)) %>%
    group_by(Finalstart, final_MMWRWeek) %>%
    slice(1) %>%
    ggplot() +
    geom_line( aes(x = final_MMWRWeek , y = PcntNum
                   ,color = FinalstartWeekYear
    ),
    alpha = .5) +
    geom_point( aes(x = final_MMWRWeek , y = PcntNum
                    ,color = FinalstartWeekYear
    ),
    alpha = .5) + 
    scale_x_date( date_labels = "%Y-%U"
                  ,  breaks = '4 weeks') +
    theme(legend.position = "top"
          ,axis.text.x = element_text(angle = 90, hjust = 1))

  # assign the MMWR week https://wwwn.cdc.gov/nndss/document/MMWR_Week_overview.pdf
  
  t <- seq(as.Date("2015-01-01")
           ,  Sys.Date(), by = "day") %>% 
    as.tibble() %>% 
    mutate(YearWeek = format(value, "%Y-%U"),
           YearMonth = format(value, "%Y-%m"),
           Week = format(value, "%U") %>% as.numeric()) %>% 
    group_by(YearWeek) %>% 
    mutate(firstweek = min(value),
           lastWeek = max(value)) %>% 
    
    fuzzy_left_join(
      df1, df2,
      by = c(
        "category" = "category",
        "date" = "start",
        "date" = "end"
      ),
      match_fun = list(`==`, `>=`, `<=`)
    )
  
  rm(list=setdiff(ls(), "data_Date")) #start with empty workspace
  
  plotMaps <- FALSE
  
  if(plotMaps) {
    
    load("hosp18.RData")
    
    load("cb_2018_us_county_500k.Rdata")
    
    cb_2018_us_county_500k <- cb_2018_us_county_500k 
    
    
    califCounties <- cb_2018_us_county_500k %>% 
      filter(STATEFP == "06") %>% 
      rmapshaper::ms_simplify(., keep = 0.01,
                              keep_shapes = TRUE) %>% 
      st_transform(4269) 
    
    rm(cb_2018_us_county_500k)
    
    d <- hosp18 %>% filter(
      # HEALTH_SVC_AREA == "12 - Inland Counties" & 
      LIC_CAT == "General Acute Care Hospital") %>% 
      select(FAC_NO, FAC_NAME, LONGITUDE, LATITUDE
             ,  HEALTH_SVC_AREA, TOT_LIC_BEDS
             ,  IC_LIC_BEDS) %>% 
      distinct( LONGITUDE, LATITUDE, .keep_all = TRUE) %>% 
      mutate_at(vars(LONGITUDE, LATITUDE),
                list(~as.numeric(.))) #%>% 
    # st_as_sf( coords = c("LONGITUDE", "LONGITUDE"), crs = 4269 ) 
    
    library(deldir)
    
    # voronoi <- deldir(d$LONGITUDE, d$LATITUDE)
    
    voronoipolygons = function(layer) {
      require(deldir)
      crds = layer@coords
      z = deldir(crds[,1], crds[,2])
      w = tile.list(z)
      polys = vector(mode='list', length=length(w))
      require(sp)
      for (i in seq(along=polys)) {
        pcrds = cbind(w[[i]]$x, w[[i]]$y)
        pcrds = rbind(pcrds, pcrds[1,])
        polys[[i]] = Polygons(list(Polygon(pcrds)), ID=as.character(i))
      }
      SP = SpatialPolygons(polys)
      voronoi = SpatialPolygonsDataFrame(SP
                                         ,data=data.frame(x=crds[,1], 
                                                          y=crds[,2]
                                                          ,row.names=sapply(slot(SP
                                                                                 ,  'polygons'), 
                                                                            function(x) slot(x, 'ID'))))
    }
    
    voronoiPolygon <- voronoipolygons(sp::SpatialPoints(cbind(d$LONGITUDE,
                                                              d$LATITUDE), 
                                                        sp::CRS("+init=epsg:4269"))) %>% 
      st_as_sf () %>% 
      st_set_crs(4269) %>%
      right_join(d, 
                 by = c("x" = "LONGITUDE"
                        ,"y" = "LATITUDE")) %>% 
      st_intersection(., st_union(califCounties)) %>% 
      mutate(HospArea =  st_area(geometry))
    
    rm(list = setdiff(ls(), c("voronoiPolygon", "califCounties", 'hosp18', "data_Date")))
    gc()
    
    source("helperFunctions.r")
    
    load("cb_2018_06_tract_500.Rdata")
    
    int <- st_intersection(cb_2018_06_tract_500 %>%
                             filter(STATEFP == "06") %>% 
                             rmapshaper::ms_simplify(., keep = 0.01,
                                                     keep_shapes = TRUE) %>% 
                             mutate(TractArea =  st_area(geometry))
                           ,  voronoiPolygon) %>%
      mutate(HospTractArea =  st_area(geometry))
    
    load("CA_Data.RData")
    
    sum_St <- int %>% 
      select(GEOID, NAME, FAC_NO, FAC_NAME
             ,  HospArea, TOT_LIC_BEDS, IC_LIC_BEDS
             ,TractArea, HospTractArea) %>%
      mutate(pcntArea = HospTractArea / TractArea,
             IC_LIC_BEDS = as.numeric(IC_LIC_BEDS)) %>%  st_drop_geometry() %>% #View()
      left_join( S0101 %>% 
                   select(GEOID = GEO.id2, HC01_EST_VC01, HC01_MOE_VC01) %>%  
                   mutate_at(vars( HC01_EST_VC01, HC01_MOE_VC01),
                             list(~as.numeric(.))) %>% 
                   filter(!is.na(HC01_EST_VC01))
      ) %>% 
      mutate(tractPop = pcntArea*HC01_EST_VC01) %>% 
      group_by(FAC_NO, FAC_NAME, TOT_LIC_BEDS, IC_LIC_BEDS) %>% 
      summarise(popHosp = sum(tractPop)) %>% 
      ungroup() %>% 
      mutate(popHosp = as.numeric(popHosp),
             TOT_LIC_BEDS = as.numeric(TOT_LIC_BEDS),
             TotLicBed_over_pop = TOT_LIC_BEDS/popHosp
             ,TotLicIcBd_over_pop = IC_LIC_BEDS/popHosp)
    
    colsToMap <- c("popHosp", "TOT_LIC_BEDS"
                   ,"IC_LIC_BEDS", "TotLicBed_over_pop"
                   ,"TotLicIcBd_over_pop")
    
    measures <- c("Population\nby Hospital",  "Total\nLicensed Beds"
                  , "Total IC\nLicensed Beds", "Licensed Beds\nOver Population",
                  "Licensed Beds IC\nOver Population")
    
    for (i in seq_along(measures)) {
      
      if( !i %in% c(4,5) ) {
        
        fillBreaks<- sum_St %>%
          select(var = colsToMap[i]) %>%
          .$var  %>% 
          pretty(., 5)
        
        plot <- sum_St %>%
          select(FAC_NO, var = colsToMap[i]) %>% 
          left_join(int %>% 
                      select(GEOID, FAC_NO)) %>% 
          st_as_sf() %>% 
          ggplot() +
          geom_sf(aes(fill = var)
                  ,  color = NA
                  #,  show.legend = FALSE
          ) + 
          geom_sf(data = califCounties
                  ,aes()
                  ,fill = NA
                  ,color = "black"
                  ,alpha = 0
                  ,size = .10) +
          #scale_fill_viridis_c(trans = "sqrt", alpha = .7) +
          scale_fill_gradient2(
            name = measures[i] #"Population\nby Hospital"
            ,low = "darkgreen",
            mid = "#f1a340",
            high = "darkred"
            ,midpoint = median(fillBreaks)
            ,breaks = as.integer(fillBreaks)
            ,labels = human_numbers ) +
          geo_theme
        
        
      } else  {
        
        fillBreaks<- sum_St %>%
          select(var = colsToMap[i]) %>%
          .$var  %>% 
          pretty(., 5)
        
        plot <- sum_St %>%
          select(FAC_NO, var = colsToMap[i]) %>% 
          left_join(int %>% 
                      select(GEOID, FAC_NO)) %>% 
          st_as_sf() %>% 
          ggplot() +
          geom_sf(aes(fill = var)
                  ,  color = NA
                  #,  show.legend = FALSE
          ) +
          geom_sf(data = califCounties
                  ,aes()
                  ,fill = NA
                  ,color = "black"
                  ,alpha = 0
                  ,size = .10) +
          #scale_fill_viridis_c(trans = "sqrt", alpha = .7) +
          scale_fill_gradient2(
            trans = "sqrt"
            #alpha = .7
            ,name = measures[i]
            ,low = "darkgreen",
            mid = "#f1a340",
            high = "darkred"
            ,limits = c(min(fillBreaks), max(fillBreaks))
            ,midpoint = median(fillBreaks)
            ,breaks = fillBreaks
            ,labels = prettyFractions(fillBreaks)) +
          geo_theme
        
      }
      
      print(plot)
      
    }
    
    View(US_CoronaVirus)
    
    US_CoronaVirus %>% 
      group_by()
    
    st_centroid_within_poly <- function (poly) {
      
      # check if centroid is in polygon
      centroid <- poly %>% st_centroid() 
      in_poly <- st_within(centroid, poly, sparse = F)[[1]] 
      
      # if it is, return that centroid
      if (in_poly) return(centroid) 
      
      # if not, calculate a point on the surface and return that
      centroid_in_poly <- st_point_on_surface(poly) 
      return(centroid_in_poly)
    }
    
  }
  
  if(FALSE) {
    
    a3 <- califCounties  %>% 
      mutate(lon = map_dbl(geometry, ~st_centroid_within_poly(.x)[[1]]),
             lat = map_dbl(geometry, ~st_centroid_within_poly(.x)[[2]])) %>% 
      st_drop_geometry()
    
    
    library(geosphere)
    
    bearing(c(10,10),c(20,20))
    
    ggplot(data = califCounties) +
      geom_sf() +
      coord_sf(crs = "+proj=laea +lat_0=34 +lon_0=-118 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs ")
    
  }
  
}

dev.off()

system(paste0('open "', paste0("2019H1N1_vs_COVID19_"
                               ,data_Date %>% gsub("-","",.),".pdf"), '"'))







```